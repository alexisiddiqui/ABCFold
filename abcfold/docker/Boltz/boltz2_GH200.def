Bootstrap: docker
From: nvidia/cuda:12.6.3-devel-ubuntu24.04

%post
    mkdir -p /host/nccl

    # Install system packages
    DEBIAN_FRONTEND=noninteractive \
    apt-get update --quiet \
    && apt-get install --yes --quiet --allow-change-held-packages \
        python3.12 python3-pip python3.12-venv python3.12-dev \
        git wget gcc g++ make zlib1g-dev \
        libnccl2 libnccl-dev \
        numactl

    # Create Python virtual environment
    python3 -m venv /boltz_venv
    /boltz_venv/bin/pip3 install --no-cache-dir --upgrade pip setuptools wheel

    # Install PyTorch for ARM with CUDA 12
    /boltz_venv/bin/pip3 install --no-cache-dir \
        torch==2.4.0 \
        --index-url https://download.pytorch.org/whl/cu124

    # Install Boltz and dependencies
    /boltz_venv/bin/pip3 install --no-cache-dir \
        boltz==2.0.3 \
        cuequivariance_torch \
        cuequivariance_ops_torch-cu12

    # Cleanup
    apt-get clean && rm -rf /var/lib/apt/lists/*

%environment
    export PATH="/boltz_venv/bin:$PATH"

    # GH200 Hopper optimizations
    export XLA_FLAGS="--xla_gpu_enable_triton_gemm=false"
    export XLA_PYTHON_CLIENT_PREALLOCATE=false
    export XLA_CLIENT_MEM_FRACTION=0.90
    export TF_GPU_THREAD_MODE=gpu_private
    export TF_GPU_THREAD_COUNT=8

    # NCCL for Grace-Hopper NVLink-C2C
    export NCCL_NVLS_ENABLE=1
    export NCCL_NET_GDR_LEVEL=5
    export CUDA_DEVICE_ORDER=PCI_BUS_ID

%runscript
    exec /boltz_venv/bin/boltz "$@"

%labels
    Author Boltz_Team
    Version 2.0.3_GH200
    Architecture arm64
