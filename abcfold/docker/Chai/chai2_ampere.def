Bootstrap: docker
From: nvidia/cuda:12.4.1-devel-ubuntu22.04

%post
    # Install system packages including kalign for templates
    DEBIAN_FRONTEND=noninteractive \
    apt-get update --quiet \
    && apt-get install --yes --quiet --allow-change-held-packages \
        python3.10 python3-pip python3.10-venv python3.10-dev \
        git wget gcc g++ make zlib1g-dev \
        libnccl2 libnccl-dev \
        kalign

    # Create Python virtual environment
    python3 -m venv /chai_venv
    /chai_venv/bin/pip3 install --no-cache-dir --upgrade pip setuptools wheel

    # Install PyTorch for x86_64 with CUDA 12
    /chai_venv/bin/pip3 install --no-cache-dir \
        torch==2.4.0 torchvision torchaudio \
        --index-url https://download.pytorch.org/whl/cu124

    # Install JAX with CUDA 12 support
    /chai_venv/bin/pip3 install --no-cache-dir --upgrade \
        "jax[cuda12]" \
        -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

    # Install Chai-1 and dependencies
    /chai_venv/bin/pip3 install --no-cache-dir \
        chai_lab==0.6.1 \
        antipickle typer jaxtyping beartype pandera matplotlib

    mkdir -p /chai_venv/lib/python3.10/site-packages/downloads
    cd /chai_venv/lib/python3.10/site-packages/downloads

    wget --tries=3 --timeout=30 \
        https://chaiassets.com/chai1-inference-depencencies/conformers_v1.apkl \
        https://chaiassets.com/chai1-inference-depencencies/leaving_atoms_v1.apkl \
        || echo "Warning: Cache download failed, will download at runtime"

    # Download ESM model (large file ~3GB)
    wget --tries=3 --timeout=60 --continue \
        -P esm/ \
        https://chaiassets.com/chai1-inference-depencencies/esm2/traced_sdpa_esm2_t36_3B_UR50D_fp16.pt \
        || echo "Warning: ESM model download failed, will download at runtime"

    # Cleanup
    apt-get clean && rm -rf /var/lib/apt/lists/*

%environment
    export PATH="/chai_venv/bin:$PATH"

    # Ampere (A100/RTX3090) optimizations
    export XLA_FLAGS="--xla_gpu_enable_triton_gemm=true"
    export XLA_PYTHON_CLIENT_PREALLOCATE=true
    export XLA_CLIENT_MEM_FRACTION=0.85
    export CUDA_DEVICE_ORDER=PCI_BUS_ID

%runscript
    exec /chai_venv/bin/python3 -m chai_lab.chai1 "$@"

%labels
    Author Chai_Team
    Version 0.6.1_Ampere
    Architecture x86_64
